<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- <meta name="theme-color" content="#03c75a"> -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" th:href="@{/style.css}">
  <script th:src="@{/common.js}"></script>
  <script th:src="@{/api.js}"></script>
  <!-- <style>
    .rating-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .star {
        cursor: pointer;
        transition: fill 0.3s;
        fill: #ccc; /* 기본 별 색상 */
    }
    .star.selected {
        fill: #FFD700; /* 선택된 별 색상 */
    }
  </style> -->
</head>
<body>
  <div id="wrap" class="d-flex flex-column min-vh-100" style="padding-top: 48px;">
    <!-- 네비/헤더 -->
    <div th:insert="~{fragments/sideheader::sideheader('리뷰')}" class="px-0 container-sm fixed-top"></div>

    <!-- 컨텐츠 -->
		<div class="container-sm px-4">
			<!-- 탭 버튼 -->
			<ul class="nav nav-tabs">
					<li class="nav-item">
							<a class="nav-link" th:classappend="${tab == 'to-write'} ? 'active' : ''" href="/mypage/review?tab=to-write">작성 가능한 리뷰</a>
					</li>
					<li class="nav-item">
							<a class="nav-link" th:classappend="${tab == 'written'} ? 'active' : ''" href="/mypage/review?tab=written">작성한 리뷰</a>
					</li>
			</ul>
	
			<!-- 탭 내용 -->
			<div class="tab-content mt-3">
					<!-- 작성 가능한 리뷰 -->
					<div class="tab-pane" th:classappend="${tab == 'to-write'} ? 'active' : ''">
							<div th:each="order : ${orderItems}">
									<div th:each="product : ${order.products}">
											<div th:each="option : ${product.options}" th:if="${option.review_content == null}">
													<div class="card mb-3">
															<div class="row g-0">
																	<div class="col-md-4">
																			<img th:src="${product.image_url}" class="img-fluid rounded" alt="...">
																	</div>
																	<div class="col-md-8">
																			<div class="card-body">
																					<h5 class="card-title" th:text="${product.title}"></h5>
																					<p class="card-text" th:each="optionDetail : ${option.option}">
																						<th:block th:each="detail : ${optionDetail}">
																							<span th:text="${detail.key + ': ' + detail.value}"></span>
																						</th:block>
																					</p>
																					<!-- 별점 등록 -->
																					<div th:if="${option.rating == null}">
																						<form action="/ratingProcess" method="POST" class="mb-3">
																								<input type="hidden" name="order_detail_id" th:value="${option.order_detail_id}">
																								<div class="rating-container d-flex align-items-center mb-2">
																										<input type="submit" name="rating" value="1" id="star1-${option.order_detail_id}" class="d-none ratingValue">
																										<label for="star1-${option.order_detail_id}" class="star">☆</label>
																										<input type="submit" name="rating" value="2" id="star2-${option.order_detail_id}" class="d-none ratingValue">
																										<label for="star2-${option.order_detail_id}" class="star">☆</label>
																										<input type="submit" name="rating" value="3" id="star3-${option.order_detail_id}" class="d-none ratingValue">
																										<label for="star3-${option.order_detail_id}" class="star">☆</label>
																										<input type="submit" name="rating" value="4" id="star4-${option.order_detail_id}" class="d-none ratingValue">
																										<label for="star4-${option.order_detail_id}" class="star">☆</label>
																										<input type="submit" name="rating" value="5" id="star5-${option.order_detail_id}" class="d-none ratingValue">
																										<label for="star5-${option.order_detail_id}" class="star">☆</label>
																								</div>
																								<!-- <button type="submit" class="btn btn-dark w-100">별점 제출</button> -->
																						</form>
																				</div>
																				<!-- 리뷰 작성 -->
																				<div th:if="${option.rating != null}">
																					<div class="d-flex align-items-center mb-3">
																							<div class="rating">
																									<span th:each="i : ${#numbers.sequence(1, 5)}" 
																												th:classappend="${i <= option.rating} ? 'rating-color' : ''">★</span>
																							</div>
																							<span class="badge bg-success ms-2">별점 완료</span>
																					</div>
																					<form action="/reviewContentProcess" method="POST" th:if="${option.review_content == null}">
																							<input type="hidden" name="order_detail_id" th:value="${option.order_detail_id}">
																							<textarea class="form-control mb-2" name="review_content" placeholder="리뷰를 입력하세요"></textarea>
																							<button type="submit" class="btn btn-primary w-100">리뷰 작성</button>
																					</form>
																					<div th:if="${option.review_content != null}">
																							<p class="fw-bold">리뷰 내용:</p>
																							<p th:text="${option.review_content}"></p>
																					</div>
																			</div>
																			</div>
																	</div>
															</div>
													</div>
											</div>
									</div>
							</div>
					</div>
	
					<!-- 작성한 리뷰 -->
					<div class="tab-pane" th:classappend="${tab == 'written'} ? 'active' : ''">
							<div th:each="order : ${orderItems}">
									<div th:each="product : ${order.products}">
											<div th:each="option : ${product.options}" th:if="${option.review_content != null}">
													<div class="card mb-3">
															<div class="row g-0">
																	<div class="col-md-4">
																			<img th:src="${product.image_url}" class="img-fluid rounded" alt="...">
																	</div>
																	<div class="col-md-8">
																			<div class="card-body">
																					<h5 class="card-title" th:text="${product.title}"></h5>
																					<p class="card-text" th:each="optionDetail : ${option.option}">
																						<th:block th:each="detail : ${optionDetail}">
																							<span th:text="${detail.key + ': ' + detail.value}"></span>
																						</th:block>
																					</p>
																					<div>
																							<span th:text="'별점: ' + ${option.rating}"></span>
																							<p th:text="${option.review_content}"></p>
																					</div>
																			</div>
																	</div>
															</div>
													</div>
											</div>
									</div>
							</div>
					</div>
			</div>
	</div>
	
  

    <!-- 하단 푸터 -->
    <div th:insert="~{fragments/footer::footer}" class="container-sm fixed-bottom"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
  </script>
  <script th:inline="javascript">
    /* <![CDATA[ */
    var orderItemsJson = /*[[${orderItemsJson}]]*/ 'N/A';
    /* ]]> */

    console.log("orders: ",  JSON.parse(orderItemsJson));
  </script>
  <script>
      // 각 상품별로 별점 컨테이너와 이벤트를 개별 설정
      document.querySelectorAll(".rating-container").forEach((productRating,idx) => {
          const stars = productRating.querySelectorAll(".star");
          const ratingValue = document.querySelectorAll(".ratingValue");

          function handleStarClick(event) {
              const clickedIndex = Array.from(stars).indexOf(event.currentTarget);

              // 선택한 별과 이전 별까지 모두 'selected' 클래스 추가
              stars.forEach((star, index) => {
                  star.classList.toggle("selected", index <= clickedIndex);
              });

              // 평점 값 업데이트
              const rating = clickedIndex + 1;
              ratingValue[idx].value = rating;
              console.log("평점:", rating);

              // 모든 별에서 클릭 이벤트 제거
              stars.forEach(star => {
                  star.removeEventListener("click", handleStarClick);
              });
          }

          // 각 별에 클릭 이벤트 리스너 추가
          stars.forEach(star => {
              star.addEventListener("click", handleStarClick);
          });
      });
  </script>
</body>

</html>